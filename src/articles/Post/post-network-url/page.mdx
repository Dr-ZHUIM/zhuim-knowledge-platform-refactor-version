---
title: 输入URL行为的影响
category: Network
sidecategory:
abstract: 本文将讨论一个经典问题 😊 当输入URL后会发生什么
cover:
layer: Post
createdat: 2024-02-21 20:19
---

本文将讨论一个经典问题 😊 当输入 URL 后会发生什么，这是一个能够很好检验 Web 开发工程师水平的问题。

## 进程协同

这里可以看一张具体的流程图,可以用于更好的理解。

<Image src="/nextBlog/article_img/Network/process.jpg" />

可以在整个过程中有多个进程参与工作，这里一起了解一下主要进程的职责

1. `浏览器进程` 主要负责用户交互、子进程管理、文件储存等工作：包括地址栏，书签栏，前进后退按钮等部分的工作；负责处理浏览器的一些不可见的底层操作，比如网络请求和文件访问；

   1. `UI线程` 负责控制浏览器本身的按钮及输入框；

   2. `储存器线程` 负责控制文件等的访问；

2. `网络进程` 负责对浏览器进程与渲染进程提供网络连接与网络下载功能

3. `渲染进程` 负责单个 tab 中网页呈现的内容：把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。

## 具体过程

### 处理输入

UI 线程判断用户输入的是 query 还是 URL，如果是 query 则拼接 URL，否则访问 URL

### 查询缓存

1. `浏览器进程`将判断被查询的 URL 是否存在 301 一类已记录数据，若有则进行重定向操作

2. 浏览器通过**IPC 通信**通知`网络进程`发起请求获取网页内容，tab 页标签开始 loading 动画

3. 网络进程首先查找`浏览器缓存`，如果请求资源已被缓存，同时服务器资源没有修改，直接使用缓存资源，达到减少服务器请求的目的

> 如果使用缓存资源的话，server 会显示该资源返回 status_code 为 304

### DNS 解析

DNS 解析就是指将域名解析为服务器 IP 地址的过程

浏览器如何通过域名去查询 URL 对应的 IP 呢？

查询过程：

1. 浏览器缓存：浏览器会按照一定的频率缓存 DNS 记录，若无则下一步
2. 操作系统缓存：如果浏览器缓存中找不到需要的 DNS 记录，那就去操作系统中找，若无则下一步
3. 路由缓存： 路由器也有 DNS 缓存，若无则下一步
4. ISP（Internet Server Provider）拥有专门 DNS 服务器用以查找，若无则下一步
5. 查看本地 HOST 文件，若无则下一步
6. 在本地域名服务器进行递归查找，最终将查询的 IP 结果给 DNS 解析器
7. 根据根域名服务器 -> 顶级域名服务器 -> 域的域名服务器的顺序进行迭代查询。

### TCP 连接

找到对于 IP 后需要进行三次握手，创建 TCP 链接，如果是 https 连接，要在 tcp 三次握手之后创建加密连接，来加密通信的上层数据（建立 SSL/TLS 连接）

> TCP 三次握手
>
> 1. 第一次握手: 建立连接，客户端 A 发送 SYN=1、随机产生 Seq=client_isn 的数据包到服务器 B，等待服务器确认。
>
> 2. 第二次握手: 服务器 B 收到请求后确认联机(可以接受数据)，发起第二次握手请求，ACK=(A 的 Seq+1)、SYN=1，随机产生 Seq=client_isn 的数据包到 A。
>
> 3. 第三次握手: A 收到后检查 ACK 是否正确，若正确，A 会在发送确认包 ACK=服务器 B 的 Seq+1、ACK=1，服务器 B 收到后确认 Seq 值与 ACK 值，若正确，则建立连接。

### 发送 HTTP/HTTPS 请求

发送 http 请求 Request 的数据包

### 服务器处理请求并返回 HTTP/HTTPS 报文

接收然后数据操作后响应 Response，如果是短连接直接通过四次挥手关闭连接，否则则继续使用这个管道传输数据

如果返回头中 301 重定向，网络进程会通知 ui 线程 服务器要求重定向，之后，另外一个 URL 请求会被触发

网络进程会依据 Content-Type 来判断响应内容的格式，如果是文本或 html 用渲染进程渲染，否则如果是文件则通知下载管理器

判断是 html 之后 Safe Browsing 会查看网页是否安全，不安全网络进程会展示警告页，此外 CORB 检测(跨域资源共享)也会触发确保敏感数据不会被传递给渲染进程；

全部检查完成，网络进程确定可以导航请求网页则通知 ui 线程数据准备好了，ui 线程会查找到一个 render（渲染器）进程对页面进行渲染

### 浏览器解析渲染页面

加下来进入渲染进程的工作，其中包括多个线程：

1. 主线程 Main thread

2. 工作线程 Worker thread

3. 排版线程 Compositor thread

4. 光栅线程 Raster thread

渲染进程的工作流程如下：

1. 主线程将 html 文件转化为浏览器能够读懂的 DOM 树结构。DOM 树解析的过程是一个深度优先遍历，即先构建当前节点的所有子节点，再构建下一个兄弟节点。其中会通过网络进程加载次级资源，遇到 js 会停止构建 DOM 树，并执行 js。

2. 主线程将 css 文件转化为浏览器能够读懂的 CSSOM（css 对象模型）

3. 主线程通过得到的 DOM 树和 CSSOM 合成一棵 render tree（渲染树），和 DOM 树不一样，render tree 能识别样式

4. 通过渲染树中渲染对象的信息，计算出每一个渲染对象的位置和尺寸生成布局树（layout Tree），在布局完成后，如果发现了某个部分（尺寸、位置等）发生了变化影响了布局，那就需要倒回去重新计算渲染树，重新渲染（这就是回流）。如果某个元素的背景颜色，文字颜色等，不影响元素周围或内部布局的属性，浏览器只会根据元素的新属性重新绘制（而不会改变渲染树），使元素呈现新的外观（这就是重绘）。

5. 即使知道了不同元素的位置及样式信息，我们还需要知道不同元素的绘制先后顺序才能正确绘制出整个页面。在绘制阶段，主线程会遍历布局树以创建绘制记录。绘制记录可以看做是记录各元素绘制先后顺序的笔记。

6. 复合是一种分割页面为不同的层，并单独栅格化，随后组合为帧的技术。不同层的组合由 compositor 线程（合成器线程）完成。主线程通过得到的布局树进行图层分层并得到一个图层树。

7. 合成线程对图层进行分块处理（栅格化），并对视口区域内的图块进行位图转换（分成多个磁贴），将得到的结果通过 GPU 进程存入到 GPU 显存中。

8. （一旦磁贴被光栅化）合成线程收集位图信息（称为绘制四边形的磁贴信息）创建合成帧，并将消息通过 IPC 协议传给浏览器主进程，主进程收到消息后，会将页面内容绘制到内存中，最后再将内存显示在屏幕上。

9. 当 渲染器进程 渲染结束（渲染结束意味着该页面内的所有的页面，包括所有 iframe 都触发了 onload 时），会发送 IPC 信号到 浏览器进程， UI 线程会停止展示 tab 中的 旋转动画

### 连接结束

当数据传送完毕，需要断开 tcp 连接，此时发起 tcp 四次挥手。

1. 发起方向被动方发送报文，Fin、Ack、Seq，表示已经没有数据传输了。并进入 FIN_WAIT_1 状态。(第一次挥手：由浏览器发起的，发送给服务器，我请求报文发送完了，你准备关闭吧)

2. 被动方发送报文，Ack、Seq，表示同意关闭请求。此时主机发起方进入 FIN_WAIT_2 状态。(第二次挥手：由服务器发起的，告诉浏览器，我请求报文接受完了，我准备关闭了，你也准备吧)

3. 被动方向发起方发送报文段，Fin、Ack、Seq，请求关闭连接。并进入 LAST_ACK 状态。(第三次挥手：由服务器发起，告诉浏览器，我响应报文发送完了，你准备关闭吧)

4. 发起方向被动方发送报文段，Ack、Seq。然后进入等待 TIME_WAIT 状态。被动方收到发起方的报文段以后关闭连接。发起方等待一定时间未收到回复，则正常关闭。(第四次挥手：由浏览器发起，告诉服务器，我响应报文接受完了，我准备关闭了，你也准备吧)

